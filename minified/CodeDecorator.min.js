var CodeDecorator=AVObj.extend({initOnPageLoad:!0});
CodeDecorator.properties={typeOptions:{},detectNewType:function(b,c){this.lastObject=null;this.currentObjectScope=[];this.typeOptions[b]=c},init:function(){this.codeElements=P("code");for(var b=this.codeElements.length;b--;)this.startDecorating(this.codeElements[b])},startDecorating:function(b){var c;null!=(c=this.typeOptions[b.attribute("type")])&&(b=b.getText(),this.findMatches(b,c,{}))},findMatches:function(b,c,e){function k(b){for(var c=b.length;c--;)null!=b[c].tree&&(b[c].treeName&&(p[b[c].treeName]=
b[c].tree),k(b[c].tree))}for(var d=[e],g=null,f=0,a=[],h=[],l=[];null!==(l=c.pattern.exec(b));)a.push(l[1]),h.push(l[2]);var p={};b=[c.tree];h=0;k(c.tree);console.log("hgi",h);for(c=0;c<a.length;){for(l=0;l<b[h].length;l++)if(a[c].match(b[h][l].matches)){console.log("matches "," - ",b[h][l].matches,a[c]);for(var n in b[h][l])if("matches"!=n){var m=b[h][l][n];console.log("command",n," - ",m);switch(n){case "tick":c+=Number(m);break;case "storeValue":null==d[f][a[c]]?g=d[f][a[c]]={_pos:[c],_type:[]}:
(g=d[f][a[c]])._pos.push(c);break;case "parent":console.log("parent - ",d[f]);break;case "openScope":d.push(g);f++;break;case "closeScope":1<d.length&&(d.pop(),f--);console.log("hi all",d.length);break;case "addType":d[f]._type.push(m);break;case "goto":b.push(p[m]);h++;break;case "tree":b.push(m);h++;break;case "returnTree":0>=h-(m-1)&&(m=b.length-2),b.splice(h-(m-1),m),h=b.length-1,console.log(b.length)}}}c++}console.log(e)},findMatchesSuperior:function(b,c,e,k,d){var g=function(d,a){for(var g in d)switch(g){case "initObject":null==
this.currentObjectScope[this.currentObjectScope.length-1][a]?this.lastObject=this.currentObjectScope[this.currentObjectScope.length-1][a]={type:d.initObject,pos:[f]}:(this.currentObjectScope[this.currentObjectScope.length-1][a].type=d.initObject,this.lastObject=this.currentObjectScope[this.currentObjectScope.length-1][a].pos.push(f));break;case "openScope":this.currentObjectScope.push(this.lastObject);break;case "closeScope":1<this.currentObjectScope.length&&this.currentObjectScope.pop();break;case "addValue":console.log("adding value "+
a,this.currentObjectScope);null==this.currentObjectScope[this.currentObjectScope.length-1][a]?this.currentObjectScope[this.currentObjectScope.length-1][a]={type:d.addValue,pos:[f]}:(this.currentObjectScope[this.currentObjectScope.length-1][a].type=d.initObject,this.currentObjectScope[this.currentObjectScope.length-1][a].pos.push(f));break;case "class":null==this.currentObjectScope[this.currentObjectScope.length-1][a]?this.currentObjectScope[this.currentObjectScope.length-1][a]={type:"unknown",class:a,
pos:[]}:this.currentObjectScope[this.currentObjectScope.length-1][a].class=a;break;case "findInScope":for(var h=this.currentObjectScope.length;h--;)if(null!=this.currentObjectScope[h][a]){this.currentObjectScope[h][a].pos.push(f);break}break;case "gotoStart":f=this.findMatchesSuperior(b,c,k[k.length-d.gotoStart],k,f);break;case "tree":k.push(e),f=this.findMatchesSuperior(b,c,d.tree,k,f+1)}}.bind(this);null==d&&(d=0);for(var f=d;f<c.length;f++){d=!1;var a=c[f];if(e.exclude)for(var h=e.exclude.length;h--;)if(a==
e.exclude[h]){d=!0;break}if(!d)if(null!=e[a]){if(g(e[a],a),e[a].returnReader)return f}else if(null!=e.default&&(g(e.default,a),e.default.returnReader))return f}},findMatchesOld:function(b,c,e,k){null==k&&(k=0);for(var d=e.length;d--;)for(var g=[];g=e[d].pattern.exec(c);){for(var f=g.index,a=1;a<g.length;a++){if(null!=e[d].matches[a])switch(typeof e[d].matches[a]){case "array":this.findMatches(b,g[a],e[d].matches[a],f);break;case "object":this.findMatches(b,g[a],[e[d].matches[a]],f);break;case "string":b[f+
k]={length:g[a].length,class:e[d].matches[a]}}f+=g[a].length}console.log(g.length);console.log(c.slice(0,g.index));console.log(g)}},generateDecoratedText:function(b,c){var e="",k=0,d;for(d in b)var g=b[d],e=e+c.substr(k,d-k),e=e+("<span class='"+g.class+"'>"+c.substr(d,g.length)+"</span>"),k=Number(d)+g.length;return e+=c.substr(k)}};
CodeDecorator.detectNewType("javascript",{tree:[{matches:/.*/,treeName:"baseScope",tree:[{matches:["var"],tick:1,storeValue:!0,openScope:!0,tree:[{matches:["="],tree:[{matches:[/([0-9\.])/],storeValue:!0,addType:"number"},{matches:["function"],addType:"function",goto:"functionScope"},{matches:[";"],closeScope:!0,returnTree:2}]}]},{matches:["function"],tick:1,storeValue:!0,openScope:!0,addType:"function",closeScope:!0,treeName:"functionScope",tree:[{matches:/\(/,openScope:!0,tree:[{matches:/[\w\d]+/,
storeValue:!0,openScope:!0,addType:"argument",closeScope:!0},{matches:/\)/,closeScope:!0,goto:"methodScope"}]}]}]},{treeName:"methodScope",tree:[{matches:/\{/,openScope:!0,goto:"baseScope"},{matches:/\}/,closeScope:!0,returnTree:1}]}],pattern:/([^\/\w\t]|[\/]{2}|[^\n\t\s\(\)\{\};,.]+)([ \t]*)/g});
