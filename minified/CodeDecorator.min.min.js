var CodeDecorator=AVObj.extend({initOnPageLoad:!0});
CodeDecorator.properties={typeOptions:{},detectNewType:function(b,c){this.lastObject=null;this.currentObjectScope=[];this.typeOptions[b]=c},init:function(){this.codeElements=P("code");for(var b=this.codeElements.length;b--;)this.startDecorating(this.codeElements[b])},startDecorating:function(b){var c;null!=(c=this.typeOptions[b.attribute("type")])&&(b=b.getText(),this.findMatches(b,c,{}))},findMatches:function(b,c,f){function k(b){for(var c=b.length;c--;)null!=b[c].tree&&(b[c].treeName&&(p[b[c].treeName]=
b[c].tree),k(b[c].tree))}for(var d=[f],g=null,e=0,a=[],h=[],l=[];null!==(l=c.pattern.exec(b));)a.push(l[1]),h.push(l[2]);var p={};b=[c.tree];h=0;k(c.tree);console.log("hgi",h);for(c=0;c<a.length;){for(l=0;l<b[h].length;l++)if(a[c].match(b[h][l].matches)){console.log("matches "," - ",b[h][l].matches,a[c]);for(var n in b[h][l])if("matches"!=n){var m=b[h][l][n];console.log("command",n," - ",m);switch(n){case "tick":c+=Number(m);break;case "storeValue":null==d[e][a[c]]?g=d[e][a[c]]={_pos:[c],_type:[]}:
(g=d[e][a[c]])._pos.push(c);break;case "parent":console.log("parent - ",d[e]);break;case "openScope":d.push(g);e++;break;case "closeScope":1<d.length&&(d.pop(),e--);console.log("hi all",d.length);break;case "addType":d[e]._type.push(m);break;case "goto":b.push(p[m]);h++;break;case "tree":b.push(m);h++;break;case "returnTree":0>=h-(m-1)&&(m=b.length-2),b.splice(h-(m-1),m),h=b.length-1,console.log(b.length)}}}c++}console.log(f)},findMatchesSuperior:function(b,c,f,k,d){var g=function(d,a){for(var g in d)switch(g){case "initObject":null==
this.currentObjectScope[this.currentObjectScope.length-1][a]?this.lastObject=this.currentObjectScope[this.currentObjectScope.length-1][a]={type:d.initObject,pos:[e]}:(this.currentObjectScope[this.currentObjectScope.length-1][a].type=d.initObject,this.lastObject=this.currentObjectScope[this.currentObjectScope.length-1][a].pos.push(e));break;case "openScope":this.currentObjectScope.push(this.lastObject);break;case "closeScope":1<this.currentObjectScope.length&&this.currentObjectScope.pop();break;case "addValue":console.log("adding value "+
a,this.currentObjectScope);null==this.currentObjectScope[this.currentObjectScope.length-1][a]?this.currentObjectScope[this.currentObjectScope.length-1][a]={type:d.addValue,pos:[e]}:(this.currentObjectScope[this.currentObjectScope.length-1][a].type=d.initObject,this.currentObjectScope[this.currentObjectScope.length-1][a].pos.push(e));break;case "class":null==this.currentObjectScope[this.currentObjectScope.length-1][a]?this.currentObjectScope[this.currentObjectScope.length-1][a]={type:"unknown",class:a,
pos:[]}:this.currentObjectScope[this.currentObjectScope.length-1][a].class=a;break;case "findInScope":for(var h=this.currentObjectScope.length;h--;)if(null!=this.currentObjectScope[h][a]){this.currentObjectScope[h][a].pos.push(e);break}break;case "gotoStart":e=this.findMatchesSuperior(b,c,k[k.length-d.gotoStart],k,e);break;case "tree":k.push(f),e=this.findMatchesSuperior(b,c,d.tree,k,e+1)}}.bind(this);null==d&&(d=0);for(var e=d;e<c.length;e++){d=!1;var a=c[e];if(f.exclude)for(var h=f.exclude.length;h--;)if(a==
f.exclude[h]){d=!0;break}if(!d)if(null!=f[a]){if(g(f[a],a),f[a].returnReader)return e}else if(null!=f.default&&(g(f.default,a),f.default.returnReader))return e}},findMatchesOld:function(b,c,f,k){null==k&&(k=0);for(var d=f.length;d--;)for(var g=[];g=f[d].pattern.exec(c);){for(var e=g.index,a=1;a<g.length;a++){if(null!=f[d].matches[a])switch(typeof f[d].matches[a]){case "array":this.findMatches(b,g[a],f[d].matches[a],e);break;case "object":this.findMatches(b,g[a],[f[d].matches[a]],e);break;case "string":b[e+
k]={length:g[a].length,class:f[d].matches[a]}}e+=g[a].length}console.log(g.length);console.log(c.slice(0,g.index));console.log(g)}},generateDecoratedText:function(b,c){var f="",k=0,d;for(d in b)var g=b[d],f=f+c.substr(k,d-k),f=f+("<span class='"+g.class+"'>"+c.substr(d,g.length)+"</span>"),k=Number(d)+g.length;return f+c.substr(k)}};
CodeDecorator.detectNewType("javascript",{tree:[{matches:/.*/,treeName:"baseScope",tree:[{matches:["var"],tick:1,storeValue:!0,openScope:!0,tree:[{matches:["="],tree:[{matches:[/([0-9\.])/],storeValue:!0,addType:"number"},{matches:["function"],addType:"function",goto:"functionScope"},{matches:[";"],closeScope:!0,returnTree:2}]}]},{matches:["function"],tick:1,storeValue:!0,openScope:!0,addType:"function",closeScope:!0,treeName:"functionScope",tree:[{matches:/\(/,openScope:!0,tree:[{matches:/[\w\d]+/,
storeValue:!0,openScope:!0,addType:"argument",closeScope:!0},{matches:/\)/,closeScope:!0,goto:"methodScope"}]}]}]},{treeName:"methodScope",tree:[{matches:/\{/,openScope:!0,goto:"baseScope"},{matches:/\}/,closeScope:!0,returnTree:1}]}],pattern:/([^\/\w\t]|[\/]{2}|[^\n\t\s\(\)\{\};,.]+)([ \t]*)/g});
